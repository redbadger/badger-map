<!DOCTYPE html>
<html>
  <head>
    <title>Badger Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" href="./favicon.ico" type="image/x-icon" />
    <style type="text/css">
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: Arial, Helvetica, sans-serif;
      }

      #main {
        height: 100%;
      }

      .map-info-window {
        padding: 0.5em;
      }

      .map-info-window h1 {
        font-size: 1.3em;
        margin: 0.3rem 0 1rem;
      }

      .map-info-window p {
        margin: 1rem 0 0.3rem;
      }

      .map-info-window dl {
        width: 12rem;
        margin: 1rem 0 0.3rem;
      }

      dt {
        float: left;
        clear: left;
        width: 4.2rem;
        text-align: left;
        font-weight: bold;
      }

      dt::after {
        content: ":";
      }

      dd {
        margin: 0 0 0 4.4rem;
        padding: 0 0 0.5em 0;
      }

      .map-info-window table th {
        text-align: left;
      }

      #authorize-dialog {
        width: 90%;
        max-width: 30em;
        background-color: white;
        box-sizing: border-box;
        border-radius: 15px;
        box-shadow: 0px 5px 10px 2px #888888;
        padding: 1.5em;
        position: fixed;
        top: 30%;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10;
      }

      #authorize-dialog h1 {
        margin: 0.2em 0;
        font-size: 1.5em;
        font-weight: lighter;
      }

      #authorize-button {
        margin-top: 1em;
        padding: 0.3em 0.8em;
        font-size: 1.3em;
        color: white;
        font-weight: bold;
        background-color: #212121;
        border: none;
        cursor: pointer;
      }

      #add-yourself-info {
        position: absolute;
        background-color: white;
        box-shadow: rgba(0, 0, 0, 0.3) 0px 1px 4px -1px;
        left: 0;
        bottom: 0;
        /* A bit more spacing on the right ensures the default zoom buttons are always accessible. */
        margin: 10px 60px 10px 10px;
        padding: 10px 17px;
      }

      #add-yourself-info h1 {
        font-size: 1.2em;
      }
    </style>
  </head>
  <body>
    <!--Add buttons to initiate auth sequence and sign out-->
    <div id="authorize-dialog" style="display: none;">
      <h1>Sign in to continue</h1>
      <p>You need to sign in with a Red Badger account to continue</p>
      <p>
        <button id="authorize-button">Sign in</button>
      </p>
    </div>

    <div id="main"></div>

    <div id="add-yourself-info" style="display: none;">
      <h1>ðŸ—º Not on the map yet?</h1>
      <p>
        Click on your home on the map to<br />see instructions for adding
        yourself.
      </p>
    </div>

    <script type="text/javascript">
      // Client ID and API key from the Developer Console
      const CLIENT_ID = "{{CLIENT_ID}}";
      const API_KEY = "{{API_KEY}}";

      // Array of API discovery doc URLs for APIs used by the quickstart
      const DISCOVERY_DOCS = [
        "https://sheets.googleapis.com/$discovery/rest?version=v4",
      ];

      // Authorization scopes required by the API; multiple scopes can be
      // included, separated by spaces.
      const SCOPES = "https://www.googleapis.com/auth/spreadsheets.readonly";
      const SPREADSHEET_ID = "{{SPREADSHEET_ID}}";

      const authorizeDialog = document.getElementById("authorize-dialog");
      const authorizeButton = document.getElementById("authorize-button");
      const addYourselfInfo = document.getElementById("add-yourself-info");

      let map, pinIcon; // initialised by initMap()
      const state = {
        location: null,
        locationMarker: null,
        infoWindow: null,
        people: [],
      };

      /**
       *  On load, called to load the auth2 library and API client library.
       */
      function handleClientLoad() {
        gapi.load("client:auth2", initClient);
      }

      /**
       *  Initializes the API client library and sets up sign-in state
       *  listeners.
       */
      function initClient() {
        gapi.client
          .init({
            apiKey: API_KEY,
            clientId: CLIENT_ID,
            discoveryDocs: DISCOVERY_DOCS,
            scope: SCOPES,
          })
          .then(function () {
            // Listen for sign-in state changes.
            gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

            // Handle the initial sign-in state.
            updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
            authorizeButton.onclick = handleAuthClick;
          })
          .catch(function (e) {
            console.error("Failed to initialise", e);
          });
      }

      /**
       *  Called when the signed in status changes, to update the UI
       *  appropriately. After a sign-in, the API is called.
       */
      function updateSigninStatus(isSignedIn) {
        if (isSignedIn) {
          authorizeDialog.style.display = "none";
          layoutCanvas();
          setupAddYourselfWindow();
        } else {
          authorizeDialog.style.display = "block";
        }
      }

      /**
       *  Sign in the user upon button click.
       */
      function handleAuthClick(event) {
        gapi.auth2.getAuthInstance().signIn();
      }

      /**
       *  Sign out the user upon button click.
       */
      function handleSignoutClick(event) {
        gapi.auth2.getAuthInstance().signOut();
      }

      function initMap() {
        const main = document.getElementById("main");

        map = new google.maps.Map(main, {
          center: { lat: 51.507, lng: -0.128 },
          zoom: 11,
        });

        pinIcon = new google.maps.MarkerImage(
          "./badger-pin.png",
          null /* size is determined at runtime */,
          null /* origin is 0,0 */,
          null /* anchor is bottom center of the scaled image */,
          new google.maps.Size(30, 50)
        );

        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            function (position) {
              state.location = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
              };

              state.locationMarker = new google.maps.Marker({
                position: state.location,
                icon: {
                  path: google.maps.SymbolPath.CIRCLE,
                  scale: 8,
                  strokeColor: "#f0faff",
                  strokeWeight: 2,
                  fillColor: "#1976d2",
                  fillOpacity: 1,
                },
                map,
              });

              map.setCenter(state.location);
              map.setZoom(14);
            },
            function () {
              console.info("Could not obtain location information");
            }
          );
        }
      }

      function infoWindow(dataIndex) {
        const { name, position, slack } = state.people[dataIndex];
        const content = document.createElement("div");

        content.className = "map-info-window";
        content.innerHTML =
          '<h1></h1><dl class="info"><dt class="slack">Slack</dt><dd class="slack"></dd><dt class="distance">Distance</dt><dd class="distance"></dd></dl><p class="directions"><a>Get directions</a></p>';
        content.querySelector("h1").textContent = name;
        content.querySelector("dd.slack").textContent = slack;
        content
          .querySelector("p.directions a")
          .setAttribute(
            "href",
            `https://maps.google.com?daddr=${position.lat},${position.lng}`
          );

        if (state.location) {
          // overestimate the distance to compensate for obstacles. This is super
          // scientific, obviously
          const dist = (1.22 * distance(state.location, position)).toFixed(1);
          const text = `about ${dist} km`;

          content.querySelector("dd.distance").textContent = text;
        } else {
          content.querySelectorAll("dl .distance").forEach((el) => el.remove());
        }

        return new google.maps.InfoWindow({ content });
      }

      /**
       * Get the spreadsheet data
       */
      function layoutCanvas() {
        gapi.client.sheets.spreadsheets.values
          .get({
            spreadsheetId: SPREADSHEET_ID,
            range: "people",
          })
          .then(
            function (response) {
              const people = response.result.values;

              // Initialise the markers
              state.people = people.map(function (row, idx) {
                const [name, lat, lng, slack] = row;
                const position = { lat: +lat, lng: +lng };

                const marker = new google.maps.Marker({
                  position,
                  animation: google.maps.Animation.DROP,
                  icon: pinIcon,
                  map,
                });

                marker.addListener("click", function () {
                  if (state.infoWindow && state.infoWindow.close) {
                    state.infoWindow.close();
                  }

                  state.infoWindow = infoWindow(idx);
                  state.infoWindow.open(map, marker);
                });

                return { name, position, slack };
              });
            },
            function (response) {
              console.error("Error: " + response.result.error.message);
            }
          );
      }

      /**
       * Calculate a great circle distance between two points using the Haversine
       * formula
       */
      function distance(origin, destination) {
        const rad = (n) => (n / 180) * Math.PI;
        const sin_2 = (x) => Math.sin(x) * Math.sin(x);
        const D = 2 * 6371; // Km

        const [lat1, lat2] = [rad(origin.lat), rad(destination.lat)];
        const [lng1, lng2] = [rad(origin.lng), rad(destination.lng)];

        return (
          D *
          Math.asin(
            Math.sqrt(
              sin_2((lat1 - lat2) / 2) +
                Math.cos(lat1) * Math.cos(lat2) * sin_2((lng1 - lng2) / 2)
            )
          )
        );
      }

      /**
       * Show a info window on right click, describing how to add youself to
       * the map.
       */
      function setupAddYourselfWindow() {
        const content = document.createElement("div");
        content.className = "map-info-window";
        content.innerHTML = `
          <h1>Add yourself</h1>
          <p>Open the <a href="https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/edit" target="_blank" rel="noopener">spreadsheet</a> and add your name and Slack handle.<br>Copy the coordinates from here:</p>
          <table>
            <tr>
              <th scope="row">Latitude</th>
              <td class="lat"></td>
            </tr>
            <tr>
              <th scope="row">Longitude</th>
              <td class="lng"></td>
            </tr>
          </table>
        `;
        const infowindow = new google.maps.InfoWindow({ content });
        map.addListener("click", function (e) {
          content.querySelector(".lat").textContent = e.latLng.lat();
          content.querySelector(".lng").textContent = e.latLng.lng();
          infowindow.open(map, {
            get(prop) {
              switch (prop) {
                case "position":
                  return e.latLng;
              }
            },
          });
        });
        addYourselfInfo.style.display = "block";
      }
    </script>

    <script
      async
      defer
      src="https://apis.google.com/js/api.js"
      onload="this.onload=function(){};handleClientLoad()"
      onreadystatechange="if (this.readyState === 'complete') this.onload()"
    ></script>
    <script
      src="https://maps.googleapis.com/maps/api/js?key={{API_KEY}}&callback=initMap"
      async
      defer
    ></script>
  </body>
</html>
